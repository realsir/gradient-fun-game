<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GradGame</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: monospace;
      min-height: 100vh;
      background: #ededed;
      overflow: hidden;
      position: relative; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #bgtext {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      font-size: 22px;
      line-height: 29px;
      color: #0b8a00;
      opacity: 0.15;
      white-space: pre;
      pointer-events: none;
      z-index: 0;
      user-select: none;
      background: none;
    }
    .overlay {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      z-index: 3;
      background: rgba(255,255,255,0.82);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .overlay-block {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 22px #3333;
      padding: 45px 44px 32px 44px;
      text-align: center;
      font-size: 22px;
      color: #181818;
      min-width: 300px;
      max-width: 95vw;
    }
    .big-btn {
      display: inline-block;
      margin-top: 36px;
      padding: 14px 70px;
      font-size: 24px;
      background: #222;
      color: #fafafa;
      border: none;
      border-radius: 7px;
      letter-spacing: 0.1em;
      box-shadow: 0 2px 18px #aaa2;
      cursor: pointer;
      transition: background 0.2s;
      font-family: monospace;
      font-weight: 700;
    }
    .big-btn:hover, .big-btn:focus {
      background: #111;
    }
    #ui { 
      z-index: 1;
      position: relative;
      align-items: center;
      display: flex;
      flex-direction: column;
      margin-top: 10px;
    }
    #stats {
      font-size: 20px;
      margin-bottom: 10px;
      background: #fffde6ee;
      padding: 5px 35px;
      border-radius: 10px;
      color: #1a1a1a;
      margin-top: 10px;
    }
    #gameContainer {
      position: relative;
      width: 720px;
      height: 480px;
      margin-bottom: 4px;
    }
    #game {
      display: grid;
      grid-template-columns: repeat(30, 24px);
      grid-template-rows: repeat(20, 24px);
      gap: 0;
      background: #fff;
      border: 2px solid #666;
      z-index: 1;
      position: absolute;
      top: 0;
      left: 0;
    }
    .cell {
      width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
      font-size: 21px;
      background: #fafafa;
      border: 1px solid #bbb;
      box-sizing: border-box;
      user-select: none;
      z-index: 2;
    }
    .black { color: #111 !important; font-weight: bold; }
    .info-text {
      color:#333; text-align:center; margin-bottom:14px;display:block;z-index:1;line-height:1.7
    }
    .hide { display: none !important; }

    .float-text {
      position: absolute;
      font-size: 18px;
      color: #0b8a00;
      font-weight: 700;
      pointer-events: none;
      z-index: 6;
      animation: floatUp 1.2s ease-out forwards;
    }
    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translate(-50%, 0) scale(1);
      }
      50% {
        transform: translate(-50%, -20px) scale(1.2);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50px) scale(0.8);
      }
    }
    #pauseOverlay {
      position: fixed;
      z-index: 10;
      background: rgba(11, 138, 0, 0.7);
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #fff;
      font-weight: 700;
      user-select: none;
      font-family: monospace;
      letter-spacing: 0.2em;
    }
  </style>
</head>
<body>
  <div id="bgtext"></div>
  <div id="welcome" class="overlay">
    <div class="overlay-block">
      <div style="font-size:25px;font-weight:700;margin-bottom:17px;">./ Welcome to "GradGame"</div>
       You have a single goal – collect the combinations as quickly as you can!<br /><br>

      <br>"–" these are now your advantages.<br>

      <br>"," and these are your opponents, who are best left alone<br>

      <br>"./" for each correctly completed combination, your current time increases by +2 sec.<br>

      <br>"*" bonuses give +5 points and +3 sec.<br>

      <br>"SPACE" for pause/unpause.
      <br />
      <button class="big-btn" id="startBtn">./ GRAD</button>
    </div>
  </div>
  <div id="gameover" class="overlay hide">
    <div class="overlay-block" id="overmsg">
      <div style="font-size:23px;margin-bottom:14px;" id="gameOverMsg">Time is up!</div>
      Your score: <span id="finalscore"></span><br>
      High score: <span id="highscore"></span>
      <br />
      <button class="big-btn" id="restartBtn">./ Restart</button>
    </div>
  </div>
  <div id="pauseOverlay">./ PAUSED</div>
  <div id="ui" class="hide">
    <div id="stats">
      Score: <span id="score">0</span> | Time: <span id="timer">30</span> sec | High score: <span id="highscoreTop">0</span>
    </div>
    <div id="gameContainer">
      <div id="game"></div>
    </div>
  </div>

  <script>
    function fillBgText() {
      let rows = Math.ceil(window.innerHeight / 29) + 2;
      let cols = Math.ceil(window.innerWidth / 18);
      let str = '';
      let line = '';
      let pattern = './ GradGame ';
      for(let i = 0; i < Math.ceil(cols * 1.5); i++) line += pattern;
      for(let i = 0; i < rows; i++) str += line.substr(0, cols*9) + '\n'; 
      document.getElementById("bgtext").textContent = str;
    }
    window.addEventListener('resize', fillBgText);
    fillBgText();

    const width = 30, height = 20, initialTime = 30;
    let player, goal, score, time, interval, running, gameStarted = false, paused = false;

    const gameContainer = document.getElementById('gameContainer');
    const gameDiv = document.getElementById('game');
    const scoreSpan = document.getElementById('score');
    const timerSpan = document.getElementById('timer');
    const uiDiv = document.getElementById('ui');
    const welcomeDiv = document.getElementById('welcome');
    const gameoverDiv = document.getElementById('gameover');
    const finalscore = document.getElementById('finalscore');
    const highscoreSpan = document.getElementById('highscore');
    const highscoreTop = document.getElementById('highscoreTop');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const gameOverMsg = document.getElementById('gameOverMsg');
    const pauseOverlay = document.getElementById('pauseOverlay');

    const obstacles = [];
    const enemies = [];
    const powerups = [];
    const MIN_OBS = 20;
    const MAX_OBS = 30;
    const MIN_ENEMIES = 20;
    const MAX_ENEMIES = 28;

    function isObstacle(x, y) {
      return obstacles.some(o => o.x === x && o.y === y);
    }

    function isEnemy(x, y) {
      return enemies.some(e => e.x === x && e.y === y);
    }

    function isPowerup(x, y) {
      return powerups.some(p => p.x === x && p.y === y);
    }

    function isNearGoal(x, y) {
      for (let dx = -1; dx <= 1; dx++) {
        for (let dy = -1; dy <= 1; dy++) {
          if (goal.x + dx === x && goal.y + dy === y) {
            return true;
          }
        }
      }
      return false;
    }

    function generateObstaclesAndEnemiesAndPowerups() {
      obstacles.length = 0;
      enemies.length = 0;
      powerups.length = 0;

      const obsCount = Math.floor(Math.random() * (MAX_OBS - MIN_OBS + 1)) + MIN_OBS;
      let tries = 0;
      while (obstacles.length < obsCount && tries < 1000) {
        tries++;
        const ox = Math.floor(Math.random() * width);
        const oy = Math.floor(Math.random() * height);
        if (
          (ox === player.x && oy === player.y) ||
          (ox === goal.x && oy === goal.y) ||
          isObstacle(ox, oy) ||
          isEnemy(ox, oy) ||
          isPowerup(ox, oy) ||
          isNearGoal(ox, oy)
        ) continue;
        obstacles.push({x: ox, y: oy});
      }

      const enemyCount = Math.floor(Math.random() * (MAX_ENEMIES - MIN_ENEMIES + 1)) + MIN_ENEMIES;
      tries = 0;
      while (enemies.length < enemyCount && tries < 1500) {
        tries++;
        const ex = Math.floor(Math.random() * width);
        const ey = Math.floor(Math.random() * height);
        if (
          (ex === player.x && ey === player.y) ||
          (ex === goal.x && ey === goal.y) ||
          isObstacle(ex, ey) ||
          isEnemy(ex, ey) ||
          isPowerup(ex, ey) ||
          isNearGoal(ex, ey)
        ) continue;
        enemies.push({x: ex, y: ey});
      }

      const powerupCount = 3;
      tries = 0;
      while (powerups.length < powerupCount && tries < 1000) {
        tries++;
        const px = Math.floor(Math.random() * width);
        const py = Math.floor(Math.random() * height);
        if (
          (px === player.x && py === player.y) ||
          (px === goal.x && py === goal.y) ||
          isObstacle(px, py) ||
          isEnemy(px, py) ||
          isPowerup(px, py) ||
          isNearGoal(px, py)
        ) continue;
        powerups.push({x: px, y: py});
      }
    }

    function drawGrid() {
      gameDiv.innerHTML = '';
      for(let y=0; y<height; y++) {
        for(let x=0; x<width; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          if (player.x === x && player.y === y) {
            cell.innerHTML = '<span class="black">.</span>';
          } else if (goal.x === x && goal.y === y) {
            cell.innerHTML = '<span class="black">/</span>';
          } else if (isEnemy(x, y)) {
            cell.innerHTML = '<span class="black">,</span>';
          } else if (isObstacle(x, y)) {
            cell.innerHTML = '<span class="black">-</span>';
          } else if (isPowerup(x, y)) {
            cell.innerHTML = '<span class="black">*</span>';
          } else {
            cell.innerHTML = '&nbsp;';
          }
          gameDiv.appendChild(cell);
        }
      }
    }

    function placeGoal() {
      do {
        goal.x = Math.floor(Math.random() * width);
        goal.y = Math.floor(Math.random() * height);
      } while (
        (goal.x === player.x && goal.y === player.y) ||
        (goal.x === 0) ||
        isObstacle(goal.x, goal.y) ||
        isEnemy(goal.x, goal.y) ||
        isPowerup(goal.x, goal.y)
      );
    }

    function showPlusTime(x, y, text) {
      const float = document.createElement('div');
      float.className = 'float-text';
      float.textContent = text;

      const cellSize = 24;
      const offsetX = x * cellSize + cellSize / 2;
      const offsetY = y * cellSize + cellSize / 2;

      float.style.left = offsetX + 'px';
      float.style.top = offsetY + 'px';

      gameContainer.appendChild(float);

      setTimeout(() => {
        if (float.parentNode) {
          float.parentNode.removeChild(float);
        }
      }, 1300);
    }

    function addTime(seconds) {
      time += seconds;
      timerSpan.textContent = time;
    }

    function gameOver(msg = "Time is up!") {
      gameStarted = false;
      running = false;
      uiDiv.classList.add('hide');
      gameoverDiv.classList.remove('hide');
      gameOverMsg.textContent = msg;
      finalscore.textContent = score;
      let highscore = localStorage.getItem('gradHighScore') || 0;
      if (score > highscore) {
        localStorage.setItem('gradHighScore', score);
        highscore = score;
      }
      highscoreSpan.textContent = highscore;
      highscoreTop.textContent = highscore;
    }

    function movePlayer(dx, dy) {
      if (!running || !gameStarted || paused) return;

      let newX = (player.x + dx + width) % width;
      let newY = (player.y + dy + height) % height;

      if (isObstacle(newX, newY)) {
        return;
      }
      if (isEnemy(newX, newY)) {
        gameOver("You bumped into an opponent (,)");
        return;
      }

      if (isPowerup(newX, newY)) {
        score += 5;
        addTime(3);
        showPlusTime(newX, newY, './ +3 sec +5 points');
        const idx = powerups.findIndex(p => p.x === newX && p.y === newY);
        if (idx !== -1) powerups.splice(idx, 1);
        player.x = newX;
        player.y = newY;
        scoreSpan.textContent = score;
        drawGrid();
        return;
      }

      if (newX === goal.x && newY === goal.y && dx === 1) {
        player.x = newX;
        player.y = newY;
        score++;
        scoreSpan.textContent = score;
        addTime(2);
        showPlusTime(newX, newY, './ +2 sec');
        placeGoal();
        generateObstaclesAndEnemiesAndPowerups();
      } else if (!(newX === goal.x && newY === goal.y)) {
        player.x = newX;
        player.y = newY;
      }

      drawGrid();
    }

    function startTimer() {
      clearInterval(interval);
      timerSpan.textContent = time;
      interval = setInterval(() => {
        if (!paused) {
          time--;
          if (time <= 0) {
            time = 0;
            timerSpan.textContent = 0;
            clearInterval(interval);
            running = false;
            setTimeout(gameOver, 300);
          } else {
            timerSpan.textContent = time;
          }
        }
      }, 1000);
    }

    function startGame() {
      player = {x: 15, y: 10};
      goal = {x: 0, y: 0};
      score = 0;
      time = initialTime;
      running = true;
      gameStarted = true;
      paused = false;
      scoreSpan.textContent = '0';
      timerSpan.textContent = initialTime;

      placeGoal();
      generateObstaclesAndEnemiesAndPowerups();
      drawGrid();

      uiDiv.classList.remove('hide');
      welcomeDiv.classList.add('hide');
      gameoverDiv.classList.add('hide');
      pauseOverlay.style.display = 'none';
      highscoreTop.textContent = localStorage.getItem('gradHighScore') || 0;
      startTimer();
    }

    document.addEventListener('keydown', e => {
      if (e.code === 'Space') {
        e.preventDefault();
      }
      if (e.code === 'Space' && gameStarted && running) {
        paused = !paused;
        pauseOverlay.style.display = paused ? 'flex' : 'none';
        return;
      }
      if (!running || !gameStarted || paused) return;
      if (['ArrowUp','KeyW','KeyЦ'].includes(e.code)) movePlayer(0, -1);
      if (['ArrowDown','KeyS','KeyЫ'].includes(e.code)) movePlayer(0, 1);
      if (['ArrowLeft','KeyA','KeyФ'].includes(e.code)) movePlayer(-1, 0);
      if (['ArrowRight','KeyD','KeyВ'].includes(e.code)) movePlayer(1, 0);
    });

    startBtn.onclick = startGame;
    restartBtn.onclick = startGame;
  </script>
</body>
</html>

